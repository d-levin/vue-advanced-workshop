<script src="https://unpkg.com/vue"></script>
<script src="https://wzrd.in/standalone/path-to-regexp"></script>

<div id="app">
  <router-view></router-view>
</div>

<script>
const Foo = {
  props: ['id'],
  template: `<div>foo with id: {{ id }}</div>`
}
const Bar = { template: `<div>bar</div>` }
const NotFound = { template: `<div>not found!</div>` }

const routeTable = {
  '/foo/:id': Foo,
  '/bar': Bar
}

// pre-compile patterns into regex
const compiledRouteTable = {}
Object.keys(routeTable).forEach(pattern => {
  compiledRouteTable[pattern] = {
    component: routeTable[pattern],
    regex: pathToRegexp(pattern)
  }
})

// '#/foo/123' -> foo with id: 123
// '#/bar' -> Bar
// '#/404' -> NotFound

window.addEventListener('hashchange', () => {
  app.url = window.location.hash.slice(1)
})

// path-to-regexp usage:
// const regex = pathToRegexp(pattern)
// const match = regex.exec(path)
// const params = regex.keys.reduce((params, key, index) => {
//   params[key] = match[index + 1]
// }, {})

const app = new Vue({
  el: '#app',
  data: {
    url: window.location.hash.slice(1)
  },
  render (h) {
    const path = '/' + this.url

    let componentToRender
    let props = {}

    // iterate through our compiled route table
    // and check if a route matches the current path
    // if it matches, extract dynamic segments (params) and use it as props
    // for the matched component
    Object.keys(compiledRouteTable).some(pattern => {
      const { component, regex } = compiledRouteTable[pattern]
      const match = regex.exec(path)

      if (match) {
        // we have a match!
        componentToRender = component
        regex.keys.forEach(({ name }, index) => {
          props[name] = match[index + 1]
        })
        return true
      }
    })

    return h('div', [
      h(componentToRender || NotFound, {
        props
      }),
      h('a', { attrs: { href: '#foo/123' }}, 'foo'),
      h('a', { attrs: { href: '#foo/234' }}, 'foo'),
      ' | ',
      h('a', { attrs: { href: '#bar' }}, 'bar')
    ])
  }
})

// goal:
// - display foo when url is at #foo
// - display bar when url is at #bar
// - bonus: implement links that navigate between #foo and #bar
// - bonus2: render foo and bar from child components (<foo> and <bar>)
</script>
